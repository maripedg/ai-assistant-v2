server:
  host: 0.0.0.0
  port: 8080
  cors:
    allow_origins: ["*"]
    allow_methods: ["*"]
    allow_headers: ["*"]

retrieval:
  mode: hybrid_prefer_db
  top_k: 12
  distance: dot_product
  score_kind: similarity
  docs_normalized: true
  # Mantén el comportamiento anterior: thresholds "planos"
  # NUEVO: selector de modo de puntuación y thresholds adicionales
  score_mode: normalized
  thresholds:
    low: 0.1
    high: 0.3
    raw_dot_low:  -0.50
    raw_dot_high: -0.20
    raw_cosine_low:  0.25
    raw_cosine_high: 0.55

  short_query:
    max_tokens: 2
    threshold_low: 0.20
    threshold_high: 0.45

  expansions:
    enabled: false
    terms:
      dbe:
        - digital business experience

  dedupe_by: doc_id

  legacy:
    store_metric: dot_product
    score_normalization: dot_to_sim01
    # legacy chunking: size 2000, overlap 100, separator '.'

  rag_if_any_hit: true

  # NUEVO: parámetros de ensamblado en modo híbrido
  hybrid:
    max_context_chars: 8000
    max_chunks: 1
    min_tokens_per_chunk: 0
    llm_enrichment: true
    cite_sources: true
    require_disclaimer_on_gaps: true
    # --- GATE: mínimos para permitir HYBRID ---
    min_similarity_for_hybrid: 0.3      # si max_similarity < 0.55 => forzar fallback
    min_chunks_for_hybrid: 1             # si usados < 2 => forzar fallback
    min_total_context_chars: 0        # si contexto < 1200 chars => forzar fallback

embeddings:
  active_profile: legacy_profile   # default, can be switched to standard_profile later
  alias:
    name: MY_DEMO                  # DB view/synonym used by retrieval
    active_index: v1               # v1 -> MY_DEMO_v1, v2 -> MY_DEMO_v2
  profiles:
    legacy_profile:
      index_name: MY_DEMO_v1
      chunker:
        type: char
        separator: "."
        size: 2000
        overlap: 100
      distance_metric: dot_product
      input_types:
        documents: search_document
        queries:   search_query
      metadata:
        keep:
          - source
          - chunk_id
          - page
          - lang
    standard_profile:
      index_name: MY_DEMO_v2
      chunker:
        type: tokens
        size: 900
        overlap: 0.15
      distance_metric: cosine
      input_types:
        documents: search_document
        queries:   search_query
      metadata:
        keep:
          - source
          - title
          - page
          - lang
  batching:
    batch_size: 32
    workers: 4
    rate_limit_per_min: 300
  ocr:
    enabled: false
    engine: tesseract
  dedupe:
    by_hash: true
    hash_normalization: "lower_strip_ws"

prompts:
  no_context_token: "__NO_CONTEXT__"
  rag:
    system: |
      You are a telecom assistant specialized in Oracle SBC configuration and troubleshooting.
      Use ONLY the CONTEXT provided below to answer.
      If the CONTEXT is insufficient, irrelevant, or does not contain the answer, output exactly __NO_CONTEXT__ and nothing else.
      Do not add general knowledge beyond the provided excerpts.
      Be concise, define acronyms on first mention, and cite the source filename(s) in parentheses.
      Use bullet points or numbered steps when describing configuration procedures.
    style: balanced
    max_output_tokens: 512
  # NUEVO prompt para HYBRID
  hybrid:
    system: |
      You are a technical assistant for Oracle SBC configuration topics.
      First, use the provided CONTEXT excerpts as your primary evidence.
      If minor gaps exist, you MAY add concise bridging information from general telecom knowledge,
      but never contradict or override the excerpts.
      If the CONTEXT is insufficient, irrelevant, or off-topic, output exactly __NO_CONTEXT__ and nothing else.
      Do not fabricate sources or commands that do not appear in the CONTEXT.
      Always prioritize factual details from the documents and cite the source filenames when possible.
      Format configuration steps clearly, using numbered lists when appropriate.
    max_output_tokens: 512
  fallback:
    system: |
      You are a helpful and knowledgeable assistant.
      Answer clearly and concisely using general knowledge only.
      Do NOT cite or refer to any document context.
      If the question is unrelated to your domain or cannot be answered reliably,
      explain the limitation politely and suggest how the user could rephrase or narrow the question.
      Keep the tone professional and neutral.
    max_output_tokens: 512

fallback:
  enabled: true
  policy: always_on_low_confidence
