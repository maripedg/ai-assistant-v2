server:
  host: 0.0.0.0
  port: 8080
  cors:
    allow_origins: ["*"]
    allow_methods: ["*"]
    allow_headers: ["*"]

retrieval:
  mode: hybrid_prefer_db
  top_k: 12
  distance: dot_product
  # Mantén el comportamiento anterior: thresholds "planos"
  threshold_low: 0.20
  threshold_high: 0.50
  # NUEVO: selector de modo de puntuación y thresholds adicionales
  score_mode: normalized
  thresholds:
    low: 0.20
    high: 0.50
    raw_dot_low:  -0.50
    raw_dot_high: -0.20
    raw_cosine_low:  0.25
    raw_cosine_high: 0.55

  short_query:
    max_tokens: 2
    threshold_low: 0.20
    threshold_high: 0.45

  expansions:
    enabled: false
    terms:
      dbe:
        - digital business experience

  dedupe_by: doc_id

  legacy:
    store_metric: dot_product
    score_normalization: dot_to_sim01
    # legacy chunking: size 2000, overlap 100, separator '.'

  rag_if_any_hit: true

  # NUEVO: parámetros de ensamblado en modo híbrido
  hybrid:
    max_context_chars: 8000
    max_chunks: 6
    min_tokens_per_chunk: 200
    llm_enrichment: true
    cite_sources: true
    require_disclaimer_on_gaps: true

embeddings:
  active_profile: legacy_profile   # default, can be switched to standard_profile later
  alias:
    name: MY_DEMO                  # DB view/synonym used by retrieval
    active_index: v1               # v1 -> MY_DEMO_v1, v2 -> MY_DEMO_v2
  profiles:
    legacy_profile:
      index_name: MY_DEMO_v1
      chunker:
        type: char
        separator: "."
        size: 2000
        overlap: 100
      distance_metric: dot_product
      input_types:
        documents: search_document
        queries:   search_query
      metadata:
        keep:
          - source
          - chunk_id
          - page
          - lang
    standard_profile:
      index_name: MY_DEMO_v2
      chunker:
        type: tokens
        size: 900
        overlap: 0.15
      distance_metric: cosine
      input_types:
        documents: search_document
        queries:   search_query
      metadata:
        keep:
          - source
          - title
          - page
          - lang
  batching:
    batch_size: 32
    workers: 4
    rate_limit_per_min: 300
  ocr:
    enabled: false
    engine: tesseract
  dedupe:
    by_hash: true
    hash_normalization: "lower_strip_ws"

prompts:
  no_context_token: "__NO_CONTEXT__"
  rag:
    system: |
      You are a telecom assistant. Use ONLY the CONTEXT below to answer.
      If the context is insufficient, output exactly __NO_CONTEXT__.
      Be concise, define acronyms on first mention, and cite the source filename(s).
    style: balanced
    max_output_tokens: 512
  # NUEVO prompt para HYBRID
  hybrid:
    system: |
      You are a technical assistant. First, use the provided excerpts as primary evidence.
      If minor gaps exist, you MAY add concise bridging context from general knowledge, but do not contradict the excerpts.
      Clearly prioritize doc-based facts and cite source filenames when possible.
    max_output_tokens: 512
  fallback:
    system: |
      You are a helpful assistant. Answer clearly and concisely.
    max_output_tokens: 512

fallback:
  enabled: true
  policy: always_on_low_confidence
